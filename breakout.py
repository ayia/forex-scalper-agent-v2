"""\nBreakout Strategy\n=================\nDetects breakouts using Donchian Channels and volume confirmation.\n"""\nimport pandas as pd\nimport pandas_ta as ta\nfrom typing import Optional\nfrom loguru import logger\n\nfrom base_strategy import BaseStrategy, StrategySignal, SignalDirection\nfrom config import STRATEGY_PARAMS\n\n\nclass BreakoutStrategy(BaseStrategy):\n    """\n    Breakout Strategy using Donchian Channels + Volume.\n    \n    Triggers when price breaks above/below the channel with volume surge.\n    """\n    \n    def __init__(self):\n        super().__init__("Momentum Breakout")\n        self.donchian_period = STRATEGY_PARAMS["donchian_period"]\n    \n    def _calculate_donchian(self, df: pd.DataFrame) -> pd.DataFrame:\n        """Calculate Donchian Channels."""\n        df = df.copy()\n        df["donchian_high"] = df["high"].rolling(window=self.donchian_period).max()\n        df["donchian_low"] = df["low"].rolling(window=self.donchian_period).min()\n        df["donchian_mid"] = (df["donchian_high"] + df["donchian_low"]) / 2\n        return df\n    \n    def _check_volume_surge(self, df: pd.DataFrame, threshold: float = 1.5) -> bool:\n        """Check if current volume is above average."""\n        if "volume" not in df.columns or df["volume"].sum() == 0:\n            return True  # Skip volume check if no volume data\n        vol_sma = df["volume"].rolling(window=20).mean()\n        if vol_sma.iloc[-1] > 0:\n            return df["volume"].iloc[-1] > vol_sma.iloc[-1] * threshold\n        return True\n    \n    def analyze(\n        self,\n        data_m1: pd.DataFrame,\n        data_m5: pd.DataFrame,\n        data_m15: pd.DataFrame,\n        data_h1: pd.DataFrame\n    ) -> Optional[StrategySignal]:\n        """Analyze for breakout signals."""\n        if not self.validate_data(data_m5):\n            return None\n        try:\n            df = self._calculate_donchian(data_m5)\n            curr = df.iloc[-1]\n            prev = df.iloc[-2]\n            price = curr["close"]\n            \n            signal = None\n            reason = ""\n            \n            # Bullish breakout: Close above previous Donchian High\n            if price > prev["donchian_high"] and prev["close"] <= prev["donchian_high"]:\n                if self._check_volume_surge(df):\n                    signal = SignalDirection.LONG\n                    reason = f"Bullish breakout above {prev['donchian_high']:.5f} with volume surge"\n            \n            # Bearish breakout: Close below previous Donchian Low\n            elif price < prev["donchian_low"] and prev["close"] >= prev["donchian_low"]:\n                if self._check_volume_surge(df):\n                    signal = SignalDirection.SHORT\n                    reason = f"Bearish breakout below {prev['donchian_low']:.5f} with volume surge"\n            \n            if signal is None:\n                return None\n            \n            confidence = 65\n            if self._check_volume_surge(df, threshold=2.0):\n                confidence += 15  # Extra confidence for strong volume\n            \n            return self.create_signal(\n                direction=signal,\n                confidence=confidence,\n                entry_price=price,\n                reason=reason,\n                timeframe="M5",\n                indicators={\n                    "donchian_high": curr["donchian_high"],\n                    "donchian_low": curr["donchian_low"],\n                    "volume_surge": self._check_volume_surge(df)\n                }\n            )\n        except Exception as e:\n            logger.error(f"Breakout analysis error: {e}")\n            return None
